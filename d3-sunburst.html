<link rel="import" href="../polymer/polymer.html">
<script src="../../build.min.js"></script>
<!--
`d3-sunburst`
Polymer wrapped implementation of a standard sunburst diagram (nested pie chart)

@demo demo/index.html
-->

<dom-module id="d3-sunburst">
  <template>
    <style>
      :host {
        display: block;
        /*height:600px;*/
        /*width:600px;*/
      }
    </style>
    <div class="container">

    </div>
  </template>
  <script>
    d3SunburstUtils = {
      getAncestors(node) {
        if(node.parent) {
          return [node].concat(d3SunburstUtils.getAncestors(node.parent))
        }
        return [node];
      }
    }
  </script>
  <script>
    Polymer({

      is: 'd3-sunburst',

      properties: {
        radius: {
          type: Number,
          computed: '_computeRadius(width, height)'
        },
        data: {
          type: Object,
          observer: 'construct'
        }
      },

      _computeRadius(width, height) {
        return (Math.min(this.width, this.height) / 2) - 10;
      },

      construct() {
        var color = d3.scaleOrdinal(d3.schemeCategory20c);
        formatNumber = d3.format(",d");
        var partition = d3.partition();
        x = d3.scaleLinear().range([0, 2 * Math.PI]);
        y = d3.scaleSqrt().range([0, this.radius]);

        var arc = d3.arc()
            .startAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x0))); })
            .endAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x1))); })
            .innerRadius(function(d) { return Math.max(0, y(d.y0)); })
            .outerRadius(function(d) { return Math.max(0, y(d.y1)); });

        var svg = d3.select(".container").append("svg")
            .attr("width", this.width)
            .attr("height", this.height)
            .append("g")
            .attr("transform", "translate(" + this.width / 2 + "," + (this.height / 2) + ")");

        mouseleave = function(e) {
          svg.selectAll("path")
            .style("opacity", 1);
        }

        mouseover = function(e) {
          ancestors = d3SunburstUtils.getAncestors(e);
          svg.selectAll("path")
            .style("opacity", 0.3);
          svg.selectAll("path")
            .filter((path) => ancestors.indexOf(path) != -1)
            .style("opacity", 1)
        }

        root = d3.hierarchy(this.data);
        root.sum(function(d) { return d.size; });
        var nodes = partition(root).descendants();

        svg.selectAll("path")
        .data(nodes)
        .enter().append("path")
        .attr("d", arc)
        .style("fill", function(d) { return color((d.children ? d : d.parent).data.name); })
        .on("mouseover", mouseover)
        .on("mouseleave", mouseleave)

        d3.select(self.frameElement).style("height", this.height + "px");
      }

    });
  </script>
</dom-module>
